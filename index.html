<!doctype html>
<html lang="en">
  <head>
    <title>HexGL ft Fuel</title>
    <meta charset="utf-8">
    <meta name="description" content="HexGL is a futuristic racing game built by Thibaut Despoulain (BKcore) using HTML5, Javascript and WebGL. Come challenge your friends on this fast-paced 3D game!">
    <link rel="icon" href="favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/multi.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="css/fonts.css" type="text/css" charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body>
    <div id="high_score_panel">
      HIGH SCORES:
      <ol id="high_score_list"></ol>
    </div>    
    <input type="text" style="display: none;" name="player_username" id="player_username" >
 

    <script>var exports = {};
    $(document).ready(function(){
      $('#display_username').text($('#player_username').val());
      $('#start_button_username').text($('#player_username').val());
    });
    
    </script>

    <script>
    function user(username){
      $('#player_username').val(username);
      $('#display_username').text(username);
      $('#start_button_username').text(username);
    }
        
    </script>

    <div id="step-1">      
      <div id="global"></div>
      <div id="container">
        <div id="menucontainer">
          <div id="menu">
            <i id="start"> <i id="start_button_username"></i></i>

            <img src="/css/logo-white.svg" alt="logo" width="708" height="160" />
              <p>Get behind the wheel and feel the speed of Fuel!</p>
 
            <div id="s-new_user"> 
              <div class="input-field">   
                <input type="text" name="username" id="username_input" placeholder="Username"/>
                <small id="username_text_error_small"></small><br>
              </div>
              <div class="input-field">              
                <input type="text" name="user_email" id="user_email_input" placeholder="Email (optional, but the only way to rescue your prize)"/><br>
              </div>
              <div class="input-field">              
                <input type="checkbox" id="terms_conditions" name="terms_conditions" :value="false">
                <label for="terms_conditions">I agree with the rules of the game</label>
                <small id="terms_text_error_small"></small><br>
              </div>
              <br>
              <button id="create_user_button">Ready, Set, Speed!</button>
          </div>
          </div>
        </div>
        <div id="title">
        </div>
      </div>

      <!-- Settings -->
      <button id="btn_settings">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000" height="30px" width="30px" version="1.1" id="Capa_1" viewBox="0 0 54 54" xml:space="preserve">
          <g>
            <path d="M51.22,21h-5.052c-0.812,0-1.481-0.447-1.792-1.197s-0.153-1.54,0.42-2.114l3.572-3.571   c0.525-0.525,0.814-1.224,0.814-1.966c0-0.743-0.289-1.441-0.814-1.967l-4.553-4.553c-1.05-1.05-2.881-1.052-3.933,0l-3.571,3.571   c-0.574,0.573-1.366,0.733-2.114,0.421C33.447,9.313,33,8.644,33,7.832V2.78C33,1.247,31.753,0,30.22,0H23.78   C22.247,0,21,1.247,21,2.78v5.052c0,0.812-0.447,1.481-1.197,1.792c-0.748,0.313-1.54,0.152-2.114-0.421l-3.571-3.571   c-1.052-1.052-2.883-1.05-3.933,0l-4.553,4.553c-0.525,0.525-0.814,1.224-0.814,1.967c0,0.742,0.289,1.44,0.814,1.966l3.572,3.571   c0.573,0.574,0.73,1.364,0.42,2.114S8.644,21,7.832,21H2.78C1.247,21,0,22.247,0,23.78v6.439C0,31.753,1.247,33,2.78,33h5.052   c0.812,0,1.481,0.447,1.792,1.197s0.153,1.54-0.42,2.114l-3.572,3.571c-0.525,0.525-0.814,1.224-0.814,1.966   c0,0.743,0.289,1.441,0.814,1.967l4.553,4.553c1.051,1.051,2.881,1.053,3.933,0l3.571-3.572c0.574-0.573,1.363-0.731,2.114-0.42   c0.75,0.311,1.197,0.98,1.197,1.792v5.052c0,1.533,1.247,2.78,2.78,2.78h6.439c1.533,0,2.78-1.247,2.78-2.78v-5.052   c0-0.812,0.447-1.481,1.197-1.792c0.751-0.312,1.54-0.153,2.114,0.42l3.571,3.572c1.052,1.052,2.883,1.05,3.933,0l4.553-4.553   c0.525-0.525,0.814-1.224,0.814-1.967c0-0.742-0.289-1.44-0.814-1.966l-3.572-3.571c-0.573-0.574-0.73-1.364-0.42-2.114   S45.356,33,46.168,33h5.052c1.533,0,2.78-1.247,2.78-2.78V23.78C54,22.247,52.753,21,51.22,21z M52,30.22   C52,30.65,51.65,31,51.22,31h-5.052c-1.624,0-3.019,0.932-3.64,2.432c-0.622,1.5-0.295,3.146,0.854,4.294l3.572,3.571   c0.305,0.305,0.305,0.8,0,1.104l-4.553,4.553c-0.304,0.304-0.799,0.306-1.104,0l-3.571-3.572c-1.149-1.149-2.794-1.474-4.294-0.854   c-1.5,0.621-2.432,2.016-2.432,3.64v5.052C31,51.65,30.65,52,30.22,52H23.78C23.35,52,23,51.65,23,51.22v-5.052   c0-1.624-0.932-3.019-2.432-3.64c-0.503-0.209-1.021-0.311-1.533-0.311c-1.014,0-1.997,0.4-2.761,1.164l-3.571,3.572   c-0.306,0.306-0.801,0.304-1.104,0l-4.553-4.553c-0.305-0.305-0.305-0.8,0-1.104l3.572-3.571c1.148-1.148,1.476-2.794,0.854-4.294   C10.851,31.932,9.456,31,7.832,31H2.78C2.35,31,2,30.65,2,30.22V23.78C2,23.35,2.35,23,2.78,23h5.052   c1.624,0,3.019-0.932,3.64-2.432c0.622-1.5,0.295-3.146-0.854-4.294l-3.572-3.571c-0.305-0.305-0.305-0.8,0-1.104l4.553-4.553   c0.304-0.305,0.799-0.305,1.104,0l3.571,3.571c1.147,1.147,2.792,1.476,4.294,0.854C22.068,10.851,23,9.456,23,7.832V2.78   C23,2.35,23.35,2,23.78,2h6.439C30.65,2,31,2.35,31,2.78v5.052c0,1.624,0.932,3.019,2.432,3.64   c1.502,0.622,3.146,0.294,4.294-0.854l3.571-3.571c0.306-0.305,0.801-0.305,1.104,0l4.553,4.553c0.305,0.305,0.305,0.8,0,1.104   l-3.572,3.571c-1.148,1.148-1.476,2.794-0.854,4.294c0.621,1.5,2.016,2.432,3.64,2.432h5.052C51.65,23,52,23.35,52,23.78V30.22z"/>
            <path d="M27,18c-4.963,0-9,4.037-9,9s4.037,9,9,9s9-4.037,9-9S31.963,18,27,18z M27,34c-3.859,0-7-3.141-7-7s3.141-7,7-7   s7,3.141,7,7S30.859,34,27,34z"/>
          </g>
          </svg>
      </button>      
      <div class="modal" id="modal_settings">
        <div id="settings" class="modal-content">
          <span class="close">&times;</span>
          <div id="s-controlType" class="field">Controls: Keyboard</div>
          <div id="s-quality" class="field">Quality: High</div>
          <div id="s-hud" class="field">HUD: On</div>
          <div id="s-godmode" class="field" style="display: none">Godmode: Off</div>
          <div id="s-credits" class="field">Credits</div>
        </div>
      </div>
    </div>
    <div id="step-2" style="display: none">
      <div id="ctrl-help">Click/Touch to continue.</div>
    </div>
    <div id="step-3" style="display: none">
      <div id="progressbar"></div>
    </div>
    <div id="step-4" style="display: none">
      <div id="overlay"></div>
      <div id="main"></div>
    </div>
    <div id="step-5" style="display: none">
      <div id="time"></div>
      <div id="ctrl-help">Click/Touch to continue.</div>
    </div>
    <div id="credits" style="display: none">
      <h3>Code</h3>
      <p><b>Concept and Development</b><br>Thibaut Despoulain (BKcore)</p>
      <p><b>Contributors</b><br>townxelliot<br>mahesh.kk</p>
      <p><b>Technologies</b><br>WebGL<br>JavaScript<br>CoffeeScript<br>Three.js<br>LeapMotion</p>
      <h3>Graphics</h3>
      <p><b>HexMKI base model</b><br>Charnel</p>
      <p><b>Track texture</b><br>Nobiax</p>
      <h4>Click anywhere to continue.</h4>
    </div>

    <div id="leapinfo" style="display: none"></div>
    
    <script src="libs/leap-0.4.1.min.js"></script>
    <script src="libs/Three.dev.js"></script>
    <script src="libs/ShaderExtras.js"></script>
    <script src="libs/postprocessing/EffectComposer.js"></script>
    <script src="libs/postprocessing/RenderPass.js"></script>
    <script src="libs/postprocessing/BloomPass.js"></script>
    <script src="libs/postprocessing/ShaderPass.js"></script>
    <script src="libs/postprocessing/MaskPass.js"></script>
    <script src="libs/Detector.js"></script>
    <script src="libs/Stats.js"></script>
    <script src="libs/DAT.GUI.min.js"></script>

    <script src="bkcore.coffee/controllers/TouchController.js"></script>
    <script src="bkcore.coffee/controllers/OrientationController.js"></script>
    <script src="bkcore.coffee/controllers/GamepadController.js"></script>

    <script src="bkcore.coffee/Timer.js"></script>
    <script src="bkcore.coffee/ImageData.js"></script>
    <script src="bkcore.coffee/Utils.js"></script>

    <!-- #region Fuel (Kalmia) imports -->
    <script src="fuel/ethers-5.7.2.umd.min.js"></script>
    <script src="fuel/Transactions.js"></script>

    <!-- FUELS CALL via TypeScript SDK -->
    <!--script  type="module" src="dist_ts/Trans.js"></script-->
    <!--script  type="module" src="dist_ts/Nanos.js"></script-->
    <!-- #endregion -->

    <script src="bkcore/threejs/RenderManager.js"></script>
    <script src="bkcore/threejs/Shaders.js"></script>
    <script src="bkcore/threejs/Particles.js"></script>
    <script src="bkcore/threejs/Loader.js"></script>

    <script src="bkcore/Audio.js"></script>

    <script src="bkcore/hexgl/HUD.js"></script>
    <script src="bkcore/hexgl/RaceData.js"></script>
    <script src="bkcore/hexgl/Gameplay.js"></script>
    <script src="bkcore/hexgl/ShipControls.js"></script>
    <script src="bkcore/hexgl/ShipEffects.js"></script>
    <script src="bkcore/hexgl/CameraChase.js"></script>
    <!--script src="bkcore/hexgl/Gameplay.js"></script-->

    <script src="bkcore/hexgl/tracks/Cityscape.js"></script>

    <script src="bkcore/hexgl/HexGL.js"></script>

    <script src="launch.js"></script>

<!-- CALL FUEL API-->
<script>
  $(document).ready(function(){
      $('#create_user_button').click(function(){
          var termsAccepted = $('#terms_conditions').is(":checked");
          if (!termsAccepted){
            $('#terms_text_error_small').text('Please accept the terms');
            console.error('Please accept the terms');
            return;
          }  else {            
            $('#terms_text_error_small').text('');
          }

          $('#username_input').css('border', "1px solid #ccc");
          //console.log("inside create user");
          //$('#create_user_button').prop('disabled', true);
          $('#create_user_button').css('display', "none");
          

          $('#username_text_error_small').text("");
          var username = $('#username_input').val();
          var user_email = $('#user_email_input').val();
          

          var body_data = { username: username };
    
          if (user_email !== "") {
            body_data.email = user_email;
          }
          if(username !== "") {
              $.ajax({
                  type: 'POST',
                  url: 'http://127.0.0.1:3002/users',
                  contentType: 'application/json',
                  data: JSON.stringify(body_data),
                  success: function(response) {
                      console.log('+1 TRX: ',response.data.register_transaction_id);
                      console.log('User created successfully ',response.data);
                      
                      // Optionally, do something with the response here
                      onRegistered(response.data)
                  },
                  error: function(xhr, status, error) {
                      console.error('Error creating user:', error);
                      //alert('Username Exists');
                      $('#username_input').css('border', "2px solid red");
                      $('#create_user_button').css('display', "inline-block");
                      $('#username_text_error_small').text("Username Exists");
                      $('#username_input').val("");
                      $('#user_email_input').val("");
                  }
              });
          } else {
              //alert('Please enter your username');
              $('#username_input').css('border', "2px solid red");
              $('#username_text_error_small').text('Please enter your username');
              console.error('Username cannot be empty');
              $('#create_user_button').css('display', "inline-block");          
          } 
      });
    

    // signal the parent that we're loaded.
    

    if(window.location.search){
      const params = getDecodedPathAndQuery(window.location.href)
      if(params.query?.username){
        onRegistered(params.query)
        $('#s-new_user').css('display', "none");
      }
    } else if (window.opener) {
      window.opener.postMessage('loaded', '*');
    } else if (window.parent) {
      window.parent.postMessage('loaded', '*');
    } 

    // listen for messages from the parent.
    const listenRegister = event => {
      if (event.data?.username) {
      onRegistered(event.data);

      $('#s-new_user').css('display', "none");

        window.removeEventListener('message', listenRegister, false);
      }
    };
    window.addEventListener('message', listenRegister, false); 
    
    function onRegistered(user){
      $('#create_user_button').css('display', "inline-block");
      $('#username_input').val("");
      $('#user_email_input').val("");
      $('#username_text_error_small').text("");
      $('#player_username').val(user.username);
      $('#display_username').text(user.username);
      $('#start_button_username').text(user.username);
      $('#start').click() 
    }
    
    function getDecodedPathAndQuery(routeStr) {
      if (!routeStr || typeof routeStr !== 'string') {
        return '';
      }

      const parts = decodeURIComponent(routeStr).split('?');

      if (parts.length > 1 && !!parts[1]) {
        // Path + query
        const queryStrings = parts[1].split('&');
        const query = {};
        queryStrings.forEach(x => {
          if (x) {
            const sides = x.split('=');
            if (sides.length > 1) {
              query[sides[0]] = sides[1];
            }
          }
        });
        return { path: parts[0], query };
      } else {
        // Just path
        return parts[0];
      }
    }            
  
      // Get the modal
    var modal = document.getElementById("modal_settings");

    // Get the button that opens the modal
    var btn = document.getElementById("btn_settings");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function() {
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
  });
</script>

  </body>
</html>
